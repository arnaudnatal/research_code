############################################# ATE by groups #############################################
B   <- my_z0x
S   <- (my_z1x - my_z0x)
S2        <- S+runif(length(S), 0, 0.00001)
breaks    <- quantile(S2, seq(0,1, 0.2),  include.lowest =T)
breaks[1] <- breaks[1] - 0.001
breaks[6] <- breaks[6] + 0.001
SG        <- cut(S2, breaks = breaks)
SGX       <- model.matrix(~-1+SG)
DSG       <- data.frame(as.numeric(I(as.numeric(dataout[,d])-md_x))*SGX)
colnames(DSG) <- c("G1", "G2", "G3", "G4", "G5")
dataout[,c("B", "S", "G1", "G2", "G3", "G4", "G5", "weight")] <- cbind(B, S, DSG$G1, DSG$G2, DSG$G3, DSG$G4, DSG$G5, as.numeric((1/(md_x*(1-md_x)))))
if(var(dataout$B)==0) {dataout$B <- dataout$B + rnorm(length(dataout$B),  mean=0, sd=0.1) }
if(var(dataout$S)==0) {dataout$S <- dataout$S + rnorm(length(dataout$S),  mean=0, sd=0.1) }
form1 <- as.formula(paste(y, "~", "B+S+G1+G2+G3+G4+G5 | ", fixed_effect, "| 0 |", cluster, sep=""))
a <- tryCatch({
a <- felm(form1, data=dataout, weights=dataout$weight)
},error=function(e){
cat("ERROR :",methods[l], t, i, "\n")
form1  <- as.formula(paste(y, "~", "G1+G2+G3+G4+G5 | ", fixed_effect, "| 0 |", cluster, sep=""))
reg    <- felm(form1, data=dataout, weights=dataout$weight)
return(reg)
}, warning = function(war) {
cat("WARNING :",methods[l], t, i, "\n")
form1  <- as.formula(paste(y, "~", "G1+G2+G3+G4+G5 | ", fixed_effect, "| 0 |", cluster, sep=""))
reg    <- felm(form1, data=dataout, weights=dataout$weight)
return(reg)
})
reg   <- a
coef <- (summary(reg)$coefficients['G5',1])
pval <- (summary(reg)$coefficients['G5',4])
results_test[(1+(i-1)*15):(5+((i-1)*15)),l]  <- c(coef, confint(reg, 'G5', level = 1-alpha)[1:2], (as.numeric(coef<0)*(pval/2) + as.numeric(coef>0)*(1-pval/2)),(as.numeric(coef<0)*(1-pval/2) + as.numeric(coef>0)*(pval/2)) )
coef <- (summary(reg)$coefficients['G1',1])
pval <- (summary(reg)$coefficients['G1',4])
results_test[(6+(i-1)*15):(10+((i-1)*15)),l]  <- c(coef, confint(reg, 'G1', level = 1-alpha)[1:2], (as.numeric(coef<0)*(pval/2) + as.numeric(coef>0)*(1-pval/2)),(as.numeric(coef<0)*(1-pval/2) + as.numeric(coef>0)*(pval/2)) )
test <- glht(reg, linfct = c("G5-G1==0"))
coef <- (summary(reg)$coefficients['G5',1]) - (summary(reg)$coefficients['G1',1])
pval <- summary(test)$test$pvalues[1]
results_test[(11+(i-1)*15):(15+((i-1)*15)),l] <- c((confint(test,level = 1-alpha))$confint[1:3],(as.numeric(coef<0)*(pval/2) + as.numeric(coef>0)*(1-pval/2)),(as.numeric(coef<0)*(1-pval/2) + as.numeric(coef>0)*(pval/2)))
mean <- summary(reg)$coef[c('G1','G2','G3','G4','G5'),1]
sd   <- summary(reg)$coef[c('G1','G2','G3','G4','G5'),2]
crit <- qnorm(1-alpha/(p))
results_group[((i-1)*15+1):((i-1)*15+5),l]   <- sort(mean)
results_group[((i-1)*15+6):((i-1)*15+10),l]  <- sort(mean +crit*sd)
results_group[((i-1)*15+11):((i-1)*15+15),l] <- sort(mean -crit*sd)
bestML[(1+(i-1)*2),l]  <- (sum(mean^2)/5)
################################### Best Linear Prediction Regression  ###################################
Sd            <- dataout$S- mean(dataout$S)
dataout$S_ort <- I((as.numeric(dataout[,d])-md_x)*Sd)
dataout$d_ort <- I((as.numeric(dataout[,d])-md_x))
form1 <- as.formula(paste(y, "~", "B+S+d_ort+S_ort| ", fixed_effect, "| 0 |", cluster, sep=""))
a  <- tryCatch({
a  <- felm(form1, data=dataout, weights=dataout$weight)
},error=function(e){
cat("ERROR2 :",methods[l], t, i, "\n")
form1 <- as.formula(paste(y, "~", "d_ort+S_ort| ", fixed_effect, "| 0 |", cluster, sep=""))
reg   <- felm(form1, data=dataout, weights=dataout$weight)
return(reg)
}, warning = function(war) {
cat("WARNING2 :",methods[l], t, i, "\n")
form1 <- as.formula(paste(y, "~", "d_ort+S_ort| ", fixed_effect, "| 0 |", cluster, sep=""))
reg   <- felm(form1, data=dataout, weights=dataout$weight)
return(reg)
})
reg <- a
coef <- (summary(reg)$coefficients['d_ort',1])
pval <- (summary(reg)$coefficients['d_ort',4])
results[(1+(i-1)*5):(i*5),l]      <-c(coef, confint(reg, 'd_ort', level = 1-alpha)[1:2],  (as.numeric(coef<0)*(pval/2) + as.numeric(coef>0)*(1-pval/2)),(as.numeric(coef<0)*(1-pval/2) + as.numeric(coef>0)*(pval/2)))
coef <- (summary(reg)$coefficients['S_ort',1])
pval <- (summary(reg)$coefficients['S_ort',4])
results_het[(1+(i-1)*5):(i*5),l] <- c(coef, confint(reg, 'S_ort', level = 1-alpha)[1:2],  (as.numeric(coef<0)*(pval/2) + as.numeric(coef>0)*(1-pval/2)),(as.numeric(coef<0)*(1-pval/2) + as.numeric(coef>0)*(pval/2)))
bestML[(2+(i-1)*2),l]      <- abs(summary(reg)$coefficients['S_ort',1])*sqrt(var(dataout$S))
################################################ Most/Least Affected  ################################################
high.effect     <- quantile(dataout$S, 1-thres);
low.effect      <- quantile(dataout$S, thres);
dataout$h       <- as.numeric(dataout$S>high.effect)
dataout$l       <- as.numeric(dataout$S<low.effect)
if(var(dataout$h)==0){dataout$h <- as.numeric(runif(length(dataout$h))<0.1)}
if(var(dataout$l)==0){dataout$l <- as.numeric(runif(length(dataout$l))<0.1)}
for(m in 1:length(affected)){
a  <- tryCatch({
form  <- paste(affected[m],"~h+l-1", sep="")
reg   <- lm(form, data=dataout[(dataout$h==1)| (dataout$l==1),])
coef  <- reg$coefficients['h'] - reg$coefficients['l']
test  <- glht(reg, linfct = c("h-l==0"))
coef  <- (summary(reg)$coefficients['h',1])
pval  <- (summary(reg)$coefficients['h',4])
res1  <- c(coef, confint(reg, 'h', level = 1-alpha)[1:2], (as.numeric(coef<0)*(pval/2) + as.numeric(coef>0)*(1-pval/2)),(as.numeric(coef<0)*(1-pval/2) + as.numeric(coef>0)*(pval/2)))
coef  <- (summary(reg)$coefficients['l',1])
pval  <- (summary(reg)$coefficients['l',4])
res2  <- c(coef, confint(reg, 'l', level = 1-alpha)[1:2], (as.numeric(coef<0)*(pval/2) + as.numeric(coef>0)*(1-pval/2)),(as.numeric(coef<0)*(1-pval/2) + as.numeric(coef>0)*(pval/2)))
coef  <- (summary(reg)$coefficients['h',1]) - (summary(reg)$coefficients['l',1])
pval  <- summary(test)$test$pvalues[1]
res3  <- c((confint(test,level = 1-alpha))$confint[1:3], (as.numeric(coef<0)*(pval/2) + as.numeric(coef>0)*(1-pval/2)),(as.numeric(coef<0)*(1-pval/2) + as.numeric(coef>0)*(pval/2)))
a     <- c(res1, res2, res3)
},error=function(e){
cat("ERROR3 :",methods[l], t, i, "\n")
res1  <- c(mean(dataout[(dataout$h==1),affected[m]]), mean(dataout[(dataout$h==1),affected[m]]), mean(dataout[(dataout$h==1),affected[m]]), 0.5, 0.5)
res2  <- c(mean(dataout[(dataout$l==1),affected[m]]), mean(dataout[(dataout$l==1),affected[m]]), mean(dataout[(dataout$l==1),affected[m]]), 0.5, 0.5)
res3  <- c((res1[1] - res2[1]), (res1[1] - res2[1]), (res1[1] - res2[1]), 0.5 , 0.5)
a     <- c(res1, res2, res3)
return(a)
})
table.who[((i-1)*length(affected)*15+(m-1)*15+1):((i-1)*length(affected)*15+(m)*15),l]   <- a
}
}
}
res <- c(as.vector(results_test), as.vector(results), as.vector(results_het), as.vector(results_group), as.vector(bestML), as.vector(table.who))
print(t)
r <- data.frame(res)
}
# Arnaud NATAL
# University of Bordeaux
# arnaud.natal@u-bordeaux.fr
# Debt trend analysis: v2
# June 16, 2022
#--- Introduction
# .rs.restartR()
rm(list = ls())
setwd("C:/Users/Arnaud/Documents/GitHub/research_code/evodebt")
#--- Install packages
# install.packages("klaR", dependencies = TRUE)
#--- Open packages
library(tidyverse)
library(klaR)
#--- Open datasets
data<-read.csv("shortdebttrend_v1.csv")
#--- Matrices creation
attach(data)
X<-as.matrix(cbind(cat_assets_b, cat_DAR_b, cat_DSR_b, cat_income_b))
trend<-as.data.frame(X)
detach(data)
attach(trend)
# trend<-rename(trend, dsr=V1)
#Kmodes
res.kmodes<-kmodes(trend,2,iter.max=500,weighted=FALSE,fast=TRUE)
kclust<-res.kmodes$cluster
data<-cbind(data,kclust)
inertia<-cbind(inert)
table(data$kclust)
# Arnaud NATAL
# University of Bordeaux
# arnaud.natal@u-bordeaux.fr
# Debt trend analysis: v2
# June 16, 2022
#--- Introduction
# .rs.restartR()
rm(list = ls())
setwd("C:/Users/Arnaud/Documents/GitHub/research_code/evodebt")
#--- Install packages
# install.packages("klaR", dependencies = TRUE)
#--- Open packages
library(tidyverse)
library(klaR)
#--- Open datasets
data<-read.csv("shortdebttrend_v1.csv")
#--- Matrices creation
attach(data)
X<-as.matrix(cbind(cat_assets_b, cat_DAR_b, cat_DSR_b, cat_income_b))
trend<-as.data.frame(X)
detach(data)
attach(trend)
# trend<-rename(trend, dsr=V1)
#Kmodes
res.kmodes<-kmodes(trend,2,iter.max=5000,weighted=FALSE,fast=TRUE)
kclust<-res.kmodes$cluster
data<-cbind(data,kclust)
inertia<-cbind(inert)
table(data$kclust)
# Arnaud NATAL
# University of Bordeaux
# arnaud.natal@u-bordeaux.fr
# Debt trend analysis: v2
# June 16, 2022
#--- Introduction
# .rs.restartR()
rm(list = ls())
setwd("C:/Users/Arnaud/Documents/GitHub/research_code/evodebt")
#--- Install packages
# install.packages("Factoshiny", dependencies = TRUE)
#--- Open packages
library(Factoshiny)
library(tidyverse)
#--- Open datasets
data<-read.csv("shortdebttrend_v1.csv")
#--- Matrices creation
attach(data)
X<-as.matrix(cbind(cat_assets_b, cat_DAR_b, cat_DSR_b, cat_income_b))
trend<-as.data.frame(X)
detach(data)
attach(trend)
# trend<-rename(trend, dsr=V1)
#--- Factoshiny
MCAshiny(trend)
# Arnaud NATAL
# University of Bordeaux
# arnaud.natal@u-bordeaux.fr
# Debt trend analysis: v2
# June 16, 2022
#--- Introduction
# .rs.restartR()
rm(list = ls())
setwd("C:/Users/Arnaud/Documents/GitHub/research_code/evodebt")
#--- Install packages
# install.packages("Factoshiny", dependencies = TRUE)
#--- Open packages
library(Factoshiny)
library(tidyverse)
#--- Open datasets
data<-read.csv("shortdebttrend_v1.csv")
#--- Matrices creation
attach(data)
X<-as.matrix(cbind(cat_assets_b, cat_DAR_b, cat_DSR_b, cat_income_b))
trend<-as.data.frame(X)
detach(data)
attach(trend)
# trend<-rename(trend, dsr=V1)
#--- Factoshiny
MCAshiny(trend)
# Arnaud NATAL
# University of Bordeaux
# arnaud.natal@u-bordeaux.fr
# Debt trend analysis: v2
# June 16, 2022
#--- Introduction
# .rs.restartR()
rm(list = ls())
setwd("C:/Users/Arnaud/Documents/GitHub/research_code/evodebt")
#--- Install packages
# install.packages("Factoshiny", dependencies = TRUE)
#--- Open packages
library(Factoshiny)
library(tidyverse)
#--- Open datasets
data<-read.csv("shortdebttrend_v1.csv")
#--- Matrices creation
attach(data)
X<-as.matrix(cbind(cat_assets_b, cat_DAR_b, cat_DSR_b, cat_income_b))
trend<-as.data.frame(X)
detach(data)
attach(trend)
# trend<-rename(trend, dsr=V1)
#--- Factoshiny
# MCAshiny(trend)
#--- HCPC
res.MCA<-MCA(trend,ncp=4,graph=FALSE)
res.HCPC<-HCPC(res.MCA,nb.clust=5,consol=TRUE,graph=FALSE)
inert<-res.HCPC[["call"]][["t"]][["inert.gain"]]
#--- Datasets extraction
vulnerable<-res.HCPC$data.clust
data<-cbind(data,vulnerable)
inertia<-cbind(inert)
table(vulnerable$clust)
write.csv(data,"shortdebttrend_v2.csv")
#write.csv(inertia,"inertia.csv")
# Arnaud NATAL
# University of Bordeaux
# arnaud.natal@u-bordeaux.fr
# Debt trend analysis: v2
# June 16, 2022
#--- Introduction
# .rs.restartR()
rm(list = ls())
setwd("C:/Users/Arnaud/Documents/GitHub/research_code/evodebt")
#--- Install packages
# install.packages("Factoshiny", dependencies = TRUE)
#--- Open packages
library(Factoshiny)
library(tidyverse)
#--- Open datasets
data<-read.csv("shortdebttrend_v1.csv")
#--- Matrices creation
attach(data)
X<-as.matrix(cbind(cat_assets_b, cat_DAR_b, cat_DSR_b, cat_income_b))
trend<-as.data.frame(X)
detach(data)
attach(trend)
# trend<-rename(trend, dsr=V1)
#--- Factoshiny
MCAshiny(trend)
# Arnaud NATAL
# University of Bordeaux
# arnaud.natal@u-bordeaux.fr
# Debt trend analysis: v2
# June 16, 2022
#--- Introduction
# .rs.restartR()
rm(list = ls())
setwd("C:/Users/Arnaud/Documents/GitHub/research_code/evodebt")
#--- Install packages
# install.packages("Factoshiny", dependencies = TRUE)
#--- Open packages
library(Factoshiny)
library(tidyverse)
#--- Open datasets
data<-read.csv("shortdebttrend_v1.csv")
#--- Matrices creation
attach(data)
X<-as.matrix(cbind(cat_assets_b, cat_DAR_b, cat_DSR_b, cat_income_b))
trend<-as.data.frame(X)
detach(data)
attach(trend)
# trend<-rename(trend, dsr=V1)
#--- Factoshiny
MCAshiny(trend)
# Arnaud NATAL
# University of Bordeaux
# arnaud.natal@u-bordeaux.fr
# Debt trend analysis: v2
# June 16, 2022
#--- Introduction
# .rs.restartR()
rm(list = ls())
setwd("C:/Users/Arnaud/Documents/GitHub/research_code/evodebt")
#--- Install packages
# install.packages("klaR", dependencies = TRUE)
install.pcakages("cluster", dependencies = TRUE)
#--- Open packages
library(tidyverse)
library(klaR)
library(cluster)
#--- Open datasets
data<-read.csv("shortdebttrend_v1.csv")
#--- Matrices creation
attach(data)
X<-as.matrix(cbind(cat_assets_b, cat_DAR_b, cat_DSR_b, cat_income_b))
trend<-as.data.frame(X)
detach(data)
attach(trend)
# Arnaud NATAL
# University of Bordeaux
# arnaud.natal@u-bordeaux.fr
# Debt trend analysis: v2
# June 16, 2022
#--- Introduction
# .rs.restartR()
rm(list = ls())
setwd("C:/Users/Arnaud/Documents/GitHub/research_code/evodebt")
#--- Install packages
# install.packages("klaR", dependencies = TRUE)
# install.pcakages("cluster", dependencies = TRUE)
#--- Open packages
library(tidyverse)
library(klaR)
library(cluster)
#--- Open datasets
data<-read.csv("shortdebttrend_v1.csv")
#--- Matrices creation
attach(data)
X<-as.matrix(cbind(cat_assets_b, cat_DAR_b, cat_DSR_b, cat_income_b))
trend<-as.data.frame(X)
detach(data)
attach(trend)
d_dist<-daisy(trend, metric = "gower",)
d_dist<-daisy(trend, metric = "gower")
View(trend)
# Arnaud NATAL
# University of Bordeaux
# arnaud.natal@u-bordeaux.fr
# Debt trend analysis: v2
# June 16, 2022
#--- Introduction
# .rs.restartR()
rm(list = ls())
setwd("C:/Users/Arnaud/Documents/GitHub/research_code/evodebt")
#--- Install packages
# install.packages("klaR", dependencies = TRUE)
# install.pcakages("cluster", dependencies = TRUE)
#--- Open packages
library(tidyverse)
library(klaR)
library(cluster)
#--- Open datasets
data<-read.csv("shortdebttrend_v1.csv")
#--- Matrices creation
attach(data)
# Arnaud NATAL
# University of Bordeaux
# arnaud.natal@u-bordeaux.fr
# Debt trend analysis: v2
# June 16, 2022
#--- Introduction
# .rs.restartR()
rm(list = ls())
setwd("C:/Users/Arnaud/Documents/GitHub/research_code/evodebt")
#--- Install packages
# install.packages("klaR", dependencies = TRUE)
# install.pcakages("cluster", dependencies = TRUE)
#--- Open packages
library(tidyverse)
library(klaR)
library(cluster)
#--- Open datasets
data<-read.csv("shortdebttrend_v1.csv")
#--- Matrices creation
attach(data)
X<-as.matrix(cbind(cat_assets_b_1, cat_assets_b_2, cat_assets_b_3, cat_DAR_b_1, cat_DAR_b_2, cat_DAR_b_3, cat_DSR_b_1, cat_DSR_b_2, cat_DSR_b_3, cat_income_b_1, cat_income_b_2, cat_income_b_3))
trend<-as.data.frame(X)
detach(data)
attach(trend)
View(trend)
d_dist<-daisy(trend, metric = "gower")
hc<-hclust(d_dist, method = "complete")
plot(hc, labels=FALSE)
# Arnaud NATAL
# University of Bordeaux
# arnaud.natal@u-bordeaux.fr
# Debt trend analysis: v2
# June 16, 2022
#--- Introduction
# .rs.restartR()
rm(list = ls())
setwd("C:/Users/Arnaud/Documents/GitHub/research_code/evodebt")
#--- Install packages
# install.packages("klaR", dependencies = TRUE)
# install.pcakages("cluster", dependencies = TRUE)
#--- Open packages
library(tidyverse)
library(klaR)
library(cluster)
#--- Open datasets
data<-read.csv("shortdebttrend_v1.csv")
#--- Matrices creation
attach(data)
X<-as.matrix(cbind(cat_assets_b_1, cat_assets_b_2, cat_assets_b_3, cat_DAR_b_1, cat_DAR_b_2, cat_DAR_b_3, cat_DSR_b_1, cat_DSR_b_2, cat_DSR_b_3, cat_income_b_1, cat_income_b_2, cat_income_b_3))
trend<-as.data.frame(X)
detach(data)
attach(trend)
#--- Hierarchical Ascendant
d_dist<-daisy(trend, metric = "gower")
hc<-hclust(d_dist, method = "ward.D2")
plot(hc, labels=FALSE)
rect.hclust(hc, k=3, border="red")
cluster<-cutree(hc, k=3)
data<-cbind(trend,as.factor(cluster))
View(data)
res.kmodes<-kmodes(trend,as.factor(cluster),iter.max=500,weighted=FALSE,fast=TRUE)
res.kmodes<-kmodes(trend,cluster,iter.max=500,weighted=FALSE,fast=TRUE)
res.kmodes<-kmodes(trend,`cluster`,iter.max=500,weighted=FALSE,fast=TRUE)
res.kmodes<-kmodes(trend,`as.factor(cluster)`,iter.max=500,weighted=FALSE,fast=TRUE)
table(data$as.factor(cluster))
# Arnaud NATAL
# University of Bordeaux
# arnaud.natal@u-bordeaux.fr
# Debt trend analysis: v2
# June 16, 2022
#--- Introduction
# .rs.restartR()
rm(list = ls())
setwd("C:/Users/Arnaud/Documents/GitHub/research_code/evodebt")
#--- Install packages
# install.packages("klaR", dependencies = TRUE)
# install.pcakages("cluster", dependencies = TRUE)
#--- Open packages
library(tidyverse)
library(klaR)
library(cluster)
#--- Open datasets
data<-read.csv("shortdebttrend_v1.csv")
#--- Matrices creation
attach(data)
X<-as.matrix(cbind(cat_assets_b_1, cat_assets_b_2, cat_assets_b_3, cat_DAR_b_1, cat_DAR_b_2, cat_DAR_b_3, cat_DSR_b_1, cat_DSR_b_2, cat_DSR_b_3, cat_income_b_1, cat_income_b_2, cat_income_b_3))
trend<-as.data.frame(X)
detach(data)
attach(trend)
#--- Hierarchical Ascendant
d_dist<-daisy(trend, metric = "gower")
hc<-hclust(d_dist, method = "ward.D2")
plot(hc, labels=FALSE)
rect.hclust(hc, k=3, border="red")
cluster<-cutree(hc, k=3)
data<-cbind(trend,cluster)
table(data$cluster)
View(trend)
trend<-cbind(trend,cluster)
View(trend)
# Arnaud NATAL
# University of Bordeaux
# arnaud.natal@u-bordeaux.fr
# Debt trend analysis: v2
# June 16, 2022
#--- Introduction
# .rs.restartR()
rm(list = ls())
setwd("C:/Users/Arnaud/Documents/GitHub/research_code/evodebt")
#--- Install packages
# install.packages("klaR", dependencies = TRUE)
# install.pcakages("cluster", dependencies = TRUE)
#--- Open packages
library(tidyverse)
library(klaR)
library(cluster)
#--- Open datasets
data<-read.csv("shortdebttrend_v1.csv")
#--- Matrices creation
attach(data)
X<-as.matrix(cbind(cat_assets_b_1, cat_assets_b_2, cat_assets_b_3, cat_DAR_b_1, cat_DAR_b_2, cat_DAR_b_3, cat_DSR_b_1, cat_DSR_b_2, cat_DSR_b_3, cat_income_b_1, cat_income_b_2, cat_income_b_3))
trend<-as.data.frame(X)
detach(data)
attach(trend)
#--- Hierarchical Ascendant
d_dist<-daisy(trend, metric = "gower")
hc<-hclust(d_dist, method = "ward.D2")
plot(hc, labels=FALSE)
rect.hclust(hc, k=3, border="red")
cluster<-cutree(hc, k=3)
data<-cbind(trend,cluster)
trend<-cbind(trend,cluster)
table(data$cluster)
#--- Kmodes
res.kmodes<-kmodes(trend,cluster,iter.max=500,weighted=FALSE,fast=TRUE)
res.kmodes<-kmodes(trend,`cluster`,iter.max=500,weighted=FALSE,fast=TRUE)
